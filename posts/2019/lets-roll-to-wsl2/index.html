<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><link rel=prev href=https://blog.batkiz.com/posts/2019/sth-about-hosts-tool-2/><link rel=next href=https://blog.batkiz.com/posts/2019/using-wsl-nvim-in-powershell/><link rel=canonical href=https://blog.batkiz.com/posts/2019/lets-roll-to-wsl2/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>滚进 wsl2 | not b@tk1z</title><meta name=title content="滚进 wsl2 | not b@tk1z"><link rel=stylesheet href=/font/iconfont.css><style type=text/css>@import '/css/light.min.css';@import url('/css/dark.min.css') screen and (prefers-color-scheme:dark)</style><meta name=twitter:card content="summary"><meta name=twitter:title content="滚进 wsl2"><meta name=twitter:description content="本文已于 2020/05/26 更新，过时的信息已用删除线标注。 我是真没想到这都快过半年了 20H1 还没释出稳定版 早在今年上半年的 Build 2019 上，微软宣布了 wsl2，使得 wsl 不再只"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"滚进 wsl2","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.batkiz.com\/posts\/2019\/lets-roll-to-wsl2\/"},"image":{"@type":"ImageObject","url":"https:\/\/blog.batkiz.com\/cover.png","width":800,"height":600},"genre":"posts","keywords":"windows, wsl","wordcount":1506,"url":"https:\/\/blog.batkiz.com\/posts\/2019\/lets-roll-to-wsl2\/","datePublished":"2019-11-06T23:23:42\u002b08:00","dateModified":"2019-11-06T23:23:42\u002b08:00","publisher":{"@type":"Organization","name":"batkiz","logo":{"@type":"ImageObject","url":"https:\/\/blog.batkiz.com\/logo.png","width":127,"height":40}},"author":{"@type":"Person","name":"batkiz"},"description":""}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=https://blog.batkiz.com/>not b@tk1z</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about>About</a>
<a class=menu-item href=/atom.xml>RSS</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=https://blog.batkiz.com/>not b@tk1z</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about>About</a>
<a class=menu-item href=/atom.xml>RSS</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>滚进 wsl2</h1><div class=post-meta>by <a href=https://blog.batkiz.com/ rel=author>batkiz</a>
<span class=post-time>on <time datetime="November 6, 2019">November 6, 2019</time></span></div></header><div class=post-content><p>本文已于 2020/05/26 更新，过时的信息已用删除线标注。</p><p><del>我是真没想到这都快过半年了 20H1 还没释出稳定版</del></p><p>早在今年上半年的 Build 2019 上，微软<a href=https://devblogs.microsoft.com/commandline/announcing-wsl-2/>宣布了 wsl2</a>，使得 wsl 不再只是 system call 的翻译，而是切切实实跑在一个<strong>真正的</strong> Linux 内核之上。这样一来，wsl 将不再受内核的局限，能够运行 docker 等与 Linux kernel 密切相关的软件。</p><p>自宣布以来，wsl2 的开发很快提上日程，并将在 Windows 10 20H1 版本中可用。~~但想要升级至此版本，目前还需进入预览体验计划，而 Windows 10 目前的 bug 数量使我对 insider fast ring 望而却步。~~最近在经过了很长时间的心理斗争之后，我最终还是进入了快速预览版，开始体验 wsl2，下面是途中遇到的一些坑，留存至此，以备后来者避坑。</p><p>首先需要说明的是，wsl1 与 wsl2 各有优劣，两者之间并非常规意义上的「升级」，更像是一种并行。如果并非是涉及内核等问题，仅仅是执行一些上层程序，我个人建议继续使用 wsl1，这样更加节省内存等资源。（当然可以 wsl1 与 wsl2 各安装一个/多个，按需启动）</p><h2 id=安装>安装<a href=#安装 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>安装过程参考官方的 <a href=https://docs.microsoft.com/zh-cn/windows/wsl/wsl2-install>WSL 2 的安装说明</a> 即可。</p><p>首先滚入 20H1 的预览版，升级系统，而后开启 hyper-v 平台，跑一个命令将原本的 wsl1 转为 wsl2 即可。更改的过程可能要花几分钟时间，等待就好。</p><p>之后就能开始使用 wsl2 啦！</p><h2 id=各种坑>各种坑<a href=#各种坑 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>……当然，路途不宗是一帆风顺的，而是伴随着艰难险阻。</p><h3 id=虚拟机>虚拟机<a href=#虚拟机 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><del>由于 VMware 暂未支持嵌套虚拟化，所以开启了 hyper-v 之后，将无法继续使用 VMware 虚拟机。虽然 hyper-v 本身也能装个虚拟机应个急，但体验确实是远远不如 VMware 的。</del></p><p>VMware 20H1 技术预览版已支持嵌套虚拟化，可以与 hyper-v 共存，更多信息与下载链接等请 <a href=https://blogs.vmware.com/workstation/2020/01/vmware-workstation-tech-preview-20h1.html>点击此处</a>。</p><h3 id=terminal>terminal<a href=#terminal class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><del>另外就是终端问题了。</del></p><p><del>我在 wsl1 时期一直使用的终端 wsl-terminal 由于很久没有更新，所以并没有支持 wsl2，但见鬼的是我升级完之后 wsl1 也没办法用了……不过好在还有 windows terminal 这个官方的终端可以使用（虽然现在还不能输入中文有点难受）。</del></p><p><del>有一个方法则是可以先启动 powershell，然后通过命令行启动 wsl2。</del></p><p><a href=https://github.com/mskyaxl/wsl-terminal>wsl-terminal</a> 与 <a href=https://github.com/mintty/wsltty>wsl-tty</a> 均已支持 wsl2。但由于 windows terminal 的卓越体验（现已支持中文输入），我更为推荐使用 windows terminal 作为 wsl 的终端。感兴趣的可以参考一下 <a href=https://github.com/batkiz/dotfiles/blob/master/wt/settings.json>我的 windows terminal 配置</a>。</p><h3 id=代理>代理<a href=#代理 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>安装了 hyper-v 之后，会将一系列端口划入保留端口之中，其中就包括了某软件的默认端口 1080。解决方法也很简单，换一个高位端口即可。（各种配置里的更改就是一项大工程了）</p><p>但真正吊诡则是，在我最初试用 hyper-v 时并未出现这个情况，开始使用 wsl2 后才发生……</p><p>此外，wsl2 与 windows 之间存在着网络隔离，虽然 wsl 团队已全力优化但还存在着一些可能会影响体验的问题。如在 windows 中可用 <code>localhost</code> 直接访问 wsl2 的 <code>localhost</code>，但反之则不行。</p><p>如果想要在 wsl 中利用 windows 本身的代理，可以在 <code>~/.zshrc</code> 或 <code>~/.bashrc</code> 中写入以下配置（我并不熟悉 fish 所以请 fish 用户自己改改用吧）：</p><pre><code class=language-bash># wsl 2 用户请启用下面这一行
# export hostip=$(cat /etc/resolv.conf | grep -oP '(?&lt;=nameserver\ ).*')
# wsl 1 用户请启用下面这一行
# export hostip=&quot;127.0.0.1&quot;
# 请将 1080 换为自己代理软件的端口
alias socks=&quot;http_proxy=http://${hostip}:1080 https_proxy=http://${hostip}:1080 &quot;
</code></pre><p><code>source ~/.zshrc</code> 之后即可通过 <code>socks command params</code> 来在 shell 中临时使用代理。</p><h3 id=systemd>systemd<a href=#systemd class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><strong>警告：作者本人已不在 wsl 2 中使用 docker 与 genie，本部分可能存在不可预知的错误，请审慎阅读</strong></p><p>由于 wsl2 的第一个（<code>PID=1</code>）进程是维持 windows 与 wsl2 通信等所需的 <code>init</code>，因此 systemd 无法以 PID=1 启动，直接无法使用。</p><p>但是，人民群众造轮子的热情是不可磨灭的（误，我们可以用 <a href=https://github.com/arkane-systems/genie>genie</a> 来使用 systemd。</p><p>genie 的安装过程不再赘述，紧随官方文档或者使用 aur 即可。需要注意的是，genie 需要 dotnet 被引入环境变量，只需在你正使用的 shell 的配置文件（如 zsh 的 <code>~/.zshrc</code> ）中加入 <code>export DOTNET_ROOT=/opt/dotnet</code> 并 <code>source</code> 以应用即可。</p><p>此外，由于其实现原理，最好将宿主机上自定义的 hosts 文件清空，以防出现问题。</p><p>安装成功之后，只需执行 <code>genie -s</code> ，systemd 即可正常使用。</p><h3 id=docker>docker<a href=#docker class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>在 systemd 这一问题解决之后，docker 的安装与使用非常简单。</p><p><code>yay docker</code> 安装之后，只需通过 <code>systemctl</code> 启用其服务即可，换源等不再赘述。</p><h2 id=after>after<a href=#after class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>其实在这一套安装下来之后，甚至感觉有点没啥用（？</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>batkiz</span></p><p class=copyright-item></p><p class=copyright-item><span>LICENSE:</span>
<span>如无特殊声明，本博客文章均以 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a> 协议发布</span></p></div><div class=post-tags><section><i class="iconfont icon-icon-tag"></i>Tag:
<span class=tag><a href=https://blog.batkiz.com/tags/windows/>#windows</a></span>
<span class=tag><a href=https://blog.batkiz.com/tags/wsl/>#wsl</a></span></section><section><a href=javascript:window.history.back();>Back</a></span> ·
<span><a href=https://blog.batkiz.com/>Home</a></span></section></div><div class=post-nav><a href=https://blog.batkiz.com/posts/2019/sth-about-hosts-tool-2/ class=prev rel=prev title="写在 hosts-tool-go 0.1.0 之际"><i class="iconfont icon-dajiantou"></i>&nbsp;写在 hosts-tool-go 0.1.0 之际</a>
<a href=https://blog.batkiz.com/posts/2019/using-wsl-nvim-in-powershell/ class=next rel=next title="在 powershell 中无缝调用 wsl 中的 neovim">在 powershell 中无缝调用 wsl 中的 neovim&nbsp;<i class="iconfont icon-xiaojiantou"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2020</span>
<span class=author itemprop=copyrightHolder><a href=https://blog.batkiz.com/>batkiz</a> |</span>
<span>powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a>
& <a href=https://github.com/batkiz/left target=_blank rel="external nofollow noopener noreffer">left</a></span></div></footer><script src=https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=/js/dynamic.to.top.min.min.js async></script><script src=/js/main.min.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-111900041-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.loli.net/ajax/libs/mathjax/3.0.5/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdnjs.loli.net/ajax/libs/mathjax/3.0.5/es5/tex-svg.js></script><style type=text/css>@import '//cdnjs.loli.net/ajax/libs/prism/1.20.0/themes/prism-solarizedlight.min.css';@import url('//cdnjs.loli.net/ajax/libs/prism/1.20.0/themes/prism-tomorrow.min.css') screen and (prefers-color-scheme:dark)</style><script src=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/components/prism-core.min.js></script><script src=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/components/></script></div></body></html>