<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>滚进 wsl2 | not b@tk1z</title><link rel=stylesheet href=/scss/main.min.css><meta name=author content="batkiz"><meta name=description content="本文已于 2020/05/26 更新，过时的信息已用删除线标注。 我是真没想到这都快过半年了 20H1 还没释出稳定版 早在今年上半年的 Build 2019 上，微软宣布了 wsl2，使得 wsl 不再只……"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="not b@tk1z"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="not b@tk1z"><meta name=msapplication-starturl content="../../../"><meta name=msapplication-TileColor content><meta name=msapplication-TileImage content="../../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://blog.batkiz.com/posts/2019/lets-roll-to-wsl2/><meta name=twitter:card content="summary"><meta name=twitter:title content="滚进 wsl2"><meta name=twitter:description content="本文已于 2020/05/26 更新，过时的信息已用删除线标注。 我是真没想到这都快过半年了 20H1 还没释出稳定版 早在今年上半年的 Build 2019 上，微软宣布了 wsl2，使得 wsl 不再只"><meta property="og:title" content="滚进 wsl2"><meta property="og:description" content="本文已于 2020/05/26 更新，过时的信息已用删除线标注。 我是真没想到这都快过半年了 20H1 还没释出稳定版 早在今年上半年的 Build 2019 上，微软宣布了 wsl2，使得 wsl 不再只"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.batkiz.com/posts/2019/lets-roll-to-wsl2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-06T23:23:42+08:00"><meta property="article:modified_time" content="2019-11-06T23:23:42+08:00"></head><body><div class=container><nav class=navbar><div class=navbar-header><a href=https://blog.batkiz.com/>not b@tk1z</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/ title>Posts</a>
<a class=menu-item href=/links/ title>Links</a>
<a class=menu-item href=/about title>About</a>
<a class=menu-item href=/atom.xml title>RSS</a></div></nav><main class=main id=main><div class=main-inner><article class=content><header class=post-header><h1 class=post-title>滚进 wsl2</h1><div class=post-meta><div class=author>batkiz</div><div class=post-date>2019-11-06</div><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/windows>#windows</a></li><li><a href=/tags/wsl>#wsl</a></li></ul></nav></div></div></header><div class=post-content><p>本文已于 2020/05/26 更新，过时的信息已用删除线标注。</p><p><del>我是真没想到这都快过半年了 20H1 还没释出稳定版</del></p><p>早在今年上半年的 Build 2019 上，微软<a href=https://devblogs.microsoft.com/commandline/announcing-wsl-2/>宣布了 wsl2</a>，使得 wsl 不再只是 system call 的翻译，而是切切实实跑在一个<strong>真正的</strong> Linux 内核之上。这样一来，wsl 将不再受内核的局限，能够运行 docker 等与 Linux kernel 密切相关的软件。</p><p>自宣布以来，wsl2 的开发很快提上日程，并将在 Windows 10 20H1 版本中可用。<del>但想要升级至此版本，目前还需进入预览体验计划，而 Windows 10 目前的 bug 数量使我对 insider fast ring 望而却步。</del> 最近在经过了很长时间的心理斗争之后，我最终还是进入了快速预览版，开始体验 wsl2，下面是途中遇到的一些坑，留存至此，以备后来者避坑。</p><p>首先需要说明的是，wsl1 与 wsl2 各有优劣，两者之间并非常规意义上的「升级」，更像是一种并行。如果并非是涉及内核等问题，仅仅是执行一些上层程序，我个人建议继续使用 wsl1，这样更加节省内存等资源。（当然可以 wsl1 与 wsl2 各安装一个/多个，按需启动）</p><h2 id=安装>安装
<a href=#%e5%ae%89%e8%a3%85 class=anchor-link>#</a></h2><p>安装过程参考官方的 <a href=https://docs.microsoft.com/zh-cn/windows/wsl/wsl2-install>WSL 2 的安装说明</a> 即可。</p><p>首先滚入 20H1 的预览版，升级系统，而后开启 hyper-v 平台，跑一个命令将原本的 wsl1 转为 wsl2 即可。更改的过程可能要花几分钟时间，等待就好。</p><p>之后就能开始使用 wsl2 啦！</p><h2 id=各种坑>各种坑
<a href=#%e5%90%84%e7%a7%8d%e5%9d%91 class=anchor-link>#</a></h2><p>……当然，路途不总是一帆风顺的，而是伴随着艰难险阻。</p><h3 id=虚拟机>虚拟机
<a href=#%e8%99%9a%e6%8b%9f%e6%9c%ba class=anchor-link>#</a></h3><p><del>由于 VMware 暂未支持嵌套虚拟化，所以开启了 hyper-v 之后，将无法继续使用 VMware 虚拟机。虽然 hyper-v 本身也能装个虚拟机应个急，但体验确实是远远不如 VMware 的。</del></p><p>VMware 20H1 技术预览版已支持嵌套虚拟化，可以与 hyper-v 共存，更多信息与下载链接等请 <a href=https://blogs.vmware.com/workstation/2020/01/vmware-workstation-tech-preview-20h1.html>点击此处</a>。</p><h3 id=terminal>terminal
<a href=#terminal class=anchor-link>#</a></h3><p><del>另外就是终端问题了。</del></p><p><del>我在 wsl1 时期一直使用的终端 wsl-terminal 由于很久没有更新，所以并没有支持 wsl2，但见鬼的是我升级完之后 wsl1 也没办法用了……不过好在还有 windows terminal 这个官方的终端可以使用（虽然现在还不能输入中文有点难受）。</del></p><p><del>有一个方法则是可以先启动 powershell，然后通过命令行启动 wsl2。</del></p><p><a href=https://github.com/mskyaxl/wsl-terminal>wsl-terminal</a> 与 <a href=https://github.com/mintty/wsltty>wsl-tty</a> 均已支持 wsl2。但由于 windows terminal 的卓越体验（现已支持中文输入），我更为推荐使用 windows terminal 作为 wsl 的终端。感兴趣的可以参考一下 <a href=https://github.com/batkiz/dotfiles/blob/master/wt/settings.json>我的 windows terminal 配置</a>。</p><h3 id=代理>代理
<a href=#%e4%bb%a3%e7%90%86 class=anchor-link>#</a></h3><p>安装了 hyper-v 之后，会将一系列端口划入保留端口之中，其中就包括了某软件的默认端口 1080。解决方法也很简单，换一个高位端口即可。（各种配置里的更改就是一项大工程了）</p><p>但真正吊诡则是，在我最初试用 hyper-v 时并未出现这个情况，开始使用 wsl2 后才发生……</p><p>此外，wsl2 与 windows 之间存在着网络隔离，虽然 wsl 团队已全力优化但还存在着一些可能会影响体验的问题。如在 windows 中可用 <code>localhost</code> 直接访问 wsl2 的 <code>localhost</code>，但反之则不行。</p><p>如果想要在 wsl 中利用 windows 本身的代理，可以在 <code>~/.zshrc</code> 或 <code>~/.bashrc</code> 中写入以下配置（我并不熟悉 fish 所以请 fish 用户自己改改吧）：</p><pre><code class=language-bash># wsl 2 中请启用下面这一行
# export hostip=$(cat /etc/resolv.conf | grep -oP '(?&lt;=nameserver\ ).*')
# wsl 1 中请启用下面这一行
# export hostip=&quot;127.0.0.1&quot;
# 请将 1080 换为自己代理软件的端口
alias socks=&quot;http_proxy=http://${hostip}:1080 https_proxy=http://${hostip}:1080 &quot;
</code></pre><p><code>source ~/.zshrc</code> 之后即可通过 <code>socks command params</code> 来在 shell 中临时使用代理。</p><h3 id=systemd>systemd
<a href=#systemd class=anchor-link>#</a></h3><p><strong>警告：作者本人已不在 wsl 2 中使用 docker 与 genie，本部分可能存在不可预知的错误，请审慎阅读。</strong></p><p>由于 wsl2 的第一个（<code>PID=1</code>）进程是维持 windows 与 wsl2 通信等所需的 <code>init</code>，因此 systemd 无法以 PID=1 启动，直接无法使用。</p><p>但是，人民群众造轮子的热情是不可磨灭的（误），我们可以用 <a href=https://github.com/arkane-systems/genie>genie</a> 来使用 systemd。</p><p>genie 的安装过程不再赘述，紧随官方文档或者使用 aur 即可。需要注意的是，genie 需要 dotnet 被引入环境变量，只需在你正使用的 shell 的配置文件（如 zsh 的 <code>~/.zshrc</code> ）中加入 <code>export DOTNET_ROOT=/opt/dotnet</code> 并 <code>source</code> 之以应用即可。</p><p>此外，由于其实现原理，最好将宿主机上自定义的 hosts 文件清空，以防出现问题。</p><p>安装成功之后，只需执行 <code>genie -s</code> ，systemd 即可正常使用。</p><h3 id=docker>docker
<a href=#docker class=anchor-link>#</a></h3><p>在 systemd 这一问题解决之后，docker 的安装与使用非常简单。</p><p><code>yay docker</code> 安装之后，只需通过 <code>systemctl</code> 启用其服务即可，换源等不再赘述。</p><h2 id=after>after
<a href=#after class=anchor-link>#</a></h2><p>其实在这一套安装下来之后，甚至感觉有点没啥用（？</p></div></article><div class=copyright><div class=copyright-title>滚进 wsl2</div><div class=copyright-link><a href=https://blog.batkiz.com/posts/2019/lets-roll-to-wsl2/ rel="external nofollow noopenner" target=_blank one-link-mark=yes>https://blog.batkiz.com/posts/2019/lets-roll-to-wsl2/</a></div><div class=copyright-meta><div class=copyright-meta-item><div class=copyright-meta-title>本文作者</div><div class=copyright-meta-text>batkiz</div></div><div class=copyright-meta-item><div class=copyright-meta-title>发布于</div><div class=copyright-meta-text>2019-11-06</div></div><div class=copyright-meta-item><div class=copyright-meta-title>许可协议</div><div class=copyright-meta-text><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></div></div></div><div>转载或引用本文时请遵守许可协议，注明原文作者、链接，不得用于商业用途</div></div><div class=post-nav><a href=https://blog.batkiz.com/posts/2019/sth-about-hosts-tool-2/ class=prev rel=prev title="写在 hosts-tool-go 0.1.0 之际">← 写在 hosts-tool-go 0.1.0 之际</a>
<a href=https://blog.batkiz.com/posts/2019/using-wsl-nvim-in-powershell/ class=next rel=next title="在 powershell 中无缝调用 wsl 中的 neovim">在 powershell 中无缝调用 wsl 中的 neovim →</a></div></div></main><footer id=footer class=footer><section><div class=social><ul><li><a class=social-item href=mailto:batkiz@outlook.com rel="me noopener noreffer"><svg class="social-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Email</title><path d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.86t.1-.87.34-.76q.22-.34.59-.54.36-.2.87-.2t.86.2q.35.21.57.55.22.34.31.77.1.43.1.88zM24 12v9.38q0 .46-.33.8-.33.32-.8.32H7.13q-.46.0-.8-.33-.32-.33-.32-.8V18H1q-.41.0-.7-.3-.3-.29-.3-.7V7q0-.41.3-.7Q.58 6 1 6h6.5V2.55q0-.44.3-.75.3-.3.75-.3h12.9q.44.0.75.3.3.3.3.75v8.3l1.24.72h.01q.1.07.18.18.07.12.07.25zm-6-8.25v3h3v-3zm0 4.5v3h3v-3zm0 4.5v1.83l3.05-1.83zm-5.25-9v3h3.75v-3zm0 4.5v3h3.75v-3zm0 4.5v2.03l2.41 1.5 1.34-.8v-2.73zM9 3.75V6h2l.13.01.12.04v-2.3zM5.98 15.98q.9.0 1.6-.3.7-.32 1.19-.86.48-.55.73-1.28.25-.74.25-1.61.0-.83-.25-1.55-.24-.71-.71-1.24t-1.15-.83q-.68-.3-1.55-.3-.92.0-1.64.3-.71.3-1.2.85-.5.54-.75 1.3-.25.74-.25 1.63.0.85.26 1.56.26.72.74 1.23.48.52 1.17.81.69.3 1.56.3zM7.5 21h12.39L12 16.08V17q0 .41-.3.7-.29.3-.7.3H7.5zm15-.13v-7.24l-5.9 3.54z"/></svg></a></li><li><a class=social-item href=https://twitter.com/batkizc target=_blank rel="external noopener" title=Twitter><svg class="social-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></a></li><li><a class=social-item href=https://github.com/batkiz target=_blank rel="external noopener" title=GitHub><svg class="social-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a></li><li><a class=social-item href=https://t.me/batkiz rel="me noopener noreffer" target=_blank title=Telegram><svg class="social-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Telegram</title><path d="M11.944.0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0a12 12 0 00-.056.0zm4.962 7.224c.1-.002.321.023.465.14a.506.506.0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a></li></ul></div><div class=site-info><div class=copyright-info>&copy;
<span itemprop=copyrightYear>2017 - 2021</span>
<span class=author itemprop=copyrightHolder>batkiz</span></div><div class=hugo-info><span>powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/batkiz/hugo-theme-fs target=_blank rel="external nofollow noopener noreffer">fs</a></span></div></div></section></footer></div><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.main-inner img'),{background:'rgba(0, 0, 0, 0.6)'})</script><style type=text/css>@import 'https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-solarizedlight.css';@import url('https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css') screen and (prefers-color-scheme:dark)</style><script src=https://cdn.jsdelivr.net/npm/prismjs@latest/components/prism-core.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@latest/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://cdn.jsdelivr.net/npm/prismjs@latest/components/></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "fd2a175921e640c8a40b873fb5e58aaa"}'></script></body></html>