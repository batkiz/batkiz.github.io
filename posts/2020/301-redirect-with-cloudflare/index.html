<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><link rel=prev href=https://blog.batkiz.com/posts/2020/pwsh-headers-and-messy-code/><link rel=next href=https://blog.batkiz.com/posts/2020/some-pwsh-scripts-2/><link rel=canonical href=https://blog.batkiz.com/posts/2020/301-redirect-with-cloudflare/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>无服务器实现 301 跳转（with Cloudflare） | not b@tk1z</title><meta name=title content="无服务器实现 301 跳转（with Cloudflare） | not b@tk1z"><link rel=stylesheet href=/font/iconfont.css><style type=text/css>@import '/css/light.min.css';@import url('/css/dark.min.css') screen and (prefers-color-scheme:dark)</style><meta name=twitter:card content="summary"><meta name=twitter:title content="无服务器实现 301 跳转（with Cloudflare）"><meta name=twitter:description content="原因 我想通过 git.batkiz.com 访问我的 Azure DevOps 主页，但其不支持 CNAME，同时我又不想通过服务器来 301 跳转，所以我就寻思着能不能找个方法白嫖。 下面是通过 Cloudflare 白嫖的教"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"无服务器实现 301 跳转（with Cloudflare）","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.batkiz.com\/posts\/2020\/301-redirect-with-cloudflare\/"},"image":{"@type":"ImageObject","url":"https:\/\/blog.batkiz.com\/cover.png","width":800,"height":600},"genre":"posts","wordcount":407,"url":"https:\/\/blog.batkiz.com\/posts\/2020\/301-redirect-with-cloudflare\/","datePublished":"2020-07-16T22:26:33\u002b08:00","dateModified":"2020-07-16T22:26:33\u002b08:00","publisher":{"@type":"Organization","name":"batkiz","logo":{"@type":"ImageObject","url":"https:\/\/blog.batkiz.com\/logo.png","width":127,"height":40}},"author":{"@type":"Person","name":"batkiz"},"description":""}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=https://blog.batkiz.com/>not b@tk1z</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about>About</a>
<a class=menu-item href=/atom.xml>RSS</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=https://blog.batkiz.com/>not b@tk1z</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about>About</a>
<a class=menu-item href=/atom.xml>RSS</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>无服务器实现 301 跳转（with Cloudflare）</h1><div class=post-meta>by <a href=https://blog.batkiz.com/ rel=author>batkiz</a>
<span class=post-time>on <time datetime="July 16, 2020">July 16, 2020</time></span></div></header><div class=post-content><h2 id=原因>原因<a href=#原因 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>我想通过 git.batkiz.com 访问我的 Azure DevOps 主页，但其不支持 CNAME，同时我又不想通过服务器来 301 跳转，所以我就寻思着能不能找个方法白嫖。</p><p>下面是通过 Cloudflare 白嫖的教程。</p><h2 id=完整步骤>完整步骤<a href=#完整步骤 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=新建-workers>新建 workers<a href=#新建-workers class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>workers 即 Cloudflare 推出的 serverless 云函数。在 <a href=https://dash.cloudflare.com/>主页</a> 直接点击 workers 新建一个，名字随意，代码如下：</p><pre><code class=language-js>async function handleRequest() {
  return Response.redirect(someURLToRedirectTo, code);
}
addEventListener(&quot;fetch&quot;, async (event) =&gt; {
  event.respondWith(handleRequest());
});
/**
 * @param {Request} url where to redirect the response
 * @param {number?=301|302} type permanent or temporary redirect
 */
const someURLToRedirectTo = &quot;https://batkiz.visualstudio.com/&quot;;
const code = 301;
</code></pre><p>部署好之后即可通过其 <code>workers.dev</code> 域名访问了，其会在访问时 301 跳转到指定页。</p><p>可是 <code>workers.dev</code> 的域名太长了，也与最初的需求（通过 git.batkiz.com 访问我的 Azure DevOps 主页）不符。因此需要通过某种手段把此域名 CNAME 到 git.batkiz.com 这个域名上。</p><p>但云函数显然是没有 CNAME 这个说法的，所以需要借助其他路由来实现。</p><h3 id=其他路由>其他路由<a href=#其他路由 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>从 <a href=https://dash.cloudflare.com/>dash</a> 点进需要的域名设置，进入其 workers tab，选择添加路由即可。</p><p>路由示例：<code>*git.batkiz.com/*</code>，选择匹配的 worker 即可。</p><p>而后进入 dns 编辑页，给所用的域名（本例中为 git.batkiz.com）添加一个 A 记录，指向 <code>192.2.0.1</code>。</p><p>然后就能用啦！</p><hr><h2 id=参考>参考<a href=#参考 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li><a href=https://community.cloudflare.com/t/setup-workers-on-personal-domain/88012>Setup Workers on Personal Domain</a></li><li><a href=https://developers.cloudflare.com/workers/about/routes/>https://developers.cloudflare.com/workers/about/routes/</a></li></ol></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>batkiz</span></p><p class=copyright-item></p><p class=copyright-item><span>LICENSE:</span>
<span>如无特殊声明，本博客文章均以 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a> 协议发布</span></p></div><div class=post-tags><section><a href=javascript:window.history.back();>Back</a></span> ·
<span><a href=https://blog.batkiz.com/>Home</a></span></section></div><div class=post-nav><a href=https://blog.batkiz.com/posts/2020/pwsh-headers-and-messy-code/ class=prev rel=prev title="powershell, headers 与乱码"><i class="iconfont icon-dajiantou"></i>&nbsp;powershell, headers 与乱码</a>
<a href=https://blog.batkiz.com/posts/2020/some-pwsh-scripts-2/ class=next rel=next title="一些 powershell 脚本 | 其二">一些 powershell 脚本 | 其二&nbsp;<i class="iconfont icon-xiaojiantou"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2020</span>
<span class=author itemprop=copyrightHolder><a href=https://blog.batkiz.com/>batkiz</a> |</span>
<span>powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a>
& <a href=https://github.com/batkiz/left target=_blank rel="external nofollow noopener noreffer">left</a></span></div></footer><script src=https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=/js/dynamic.to.top.min.min.js async></script><script src=/js/main.min.js async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-111900041-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "fd2a175921e640c8a40b873fb5e58aaa"}'></script><style type=text/css>@import '//cdnjs.loli.net/ajax/libs/prism/1.20.0/themes/prism-solarizedlight.min.css';@import url('//cdnjs.loli.net/ajax/libs/prism/1.20.0/themes/prism-tomorrow.min.css') screen and (prefers-color-scheme:dark)</style><script src=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/components/prism-core.min.js></script><script src=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://cdnjs.loli.net/ajax/libs/prism/1.20.0/components/></script></div></body></html>